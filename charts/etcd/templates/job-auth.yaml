{{- if and .Values.auth.rbac.enabled .Values.auth.rbac.create -}}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "etcd.fullname" . }}-auth-bootstrap
  labels:
    {{- include "etcd.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": post-install
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
    "helm.sh/hook-weight": "5"
spec:
  template:
    metadata:
      labels:
        {{- include "etcd.labels" . | nindent 8 }}
    spec:
      restartPolicy: OnFailure
      imagePullSecrets:
        {{- toYaml .Values.imagePullSecrets | nindent 8 }}
      containers:
        - name: auth-bootstrap
          # Use alpine as a helper since quay.io/coreos/etcd is distroless (no shell)
          image: "alpine:3.19"
          command: ["/bin/sh", "-c", "apk add --no-cache etcd && /usr/local/bin/auth-bootstrap.sh"]
          env:
            - name: ETCDCTL_API
              value: "3"
            - name: ETCDCTL_ENDPOINTS
              value: "{{ include "etcd.scheme" . }}://{{ include "etcd.fullname" . }}:{{ .Values.etcd.clientPort }}"
            - name: ETCD_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ if .Values.auth.rbac.existingSecret }}{{ .Values.auth.rbac.existingSecret }}{{ else }}{{ include "etcd.fullname" . }}-root-password{{ end }}
                  key: {{ if .Values.auth.rbac.existingSecret }}{{ required "auth.rbac.existingSecretPasswordKey must be set when auth.rbac.existingSecret is provided" .Values.auth.rbac.existingSecretPasswordKey }}{{ else }}password{{ end }}
            {{- if .Values.tls.enabled }}
            - name: ETCDCTL_CACERT
              value: "/etc/etcd/tls/ca.crt"
            - name: ETCDCTL_CERT
              value: "/etc/etcd/tls/tls.crt"
            - name: ETCDCTL_KEY
              value: "/etc/etcd/tls/tls.key"
            {{- end }}
          volumeMounts:
            - name: script
              mountPath: /usr/local/bin/auth-bootstrap.sh
              subPath: auth-bootstrap.sh
            {{- if .Values.tls.enabled }}
            - name: tls
              mountPath: /etc/etcd/tls
              readOnly: true
            {{- end }}
      volumes:
        - name: script
          configMap:
            name: {{ include "etcd.fullname" . }}-auth-script
            defaultMode: 0755
        {{- if .Values.tls.enabled }}
        - name: tls
          secret:
            secretName: {{ .Values.tls.existingSecret }}
        {{- end }}
{{- end }}
